{
	"name": "FlowCasesDeaths",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"linkedService": {
						"referenceName": "ls_adls_covid",
						"type": "LinkedServiceReference"
					},
					"name": "srcCasesDeaths"
				},
				{
					"linkedService": {
						"referenceName": "ls_adls_covid",
						"type": "LinkedServiceReference"
					},
					"name": "PopulationCountryCode"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "ls_adls_covid",
						"type": "LinkedServiceReference"
					},
					"name": "sinkCasesDeaths"
				}
			],
			"transformations": [
				{
					"name": "ContinentEqEurope"
				},
				{
					"name": "pivotRateIndicator"
				},
				{
					"name": "pivotCountIndicator"
				},
				{
					"name": "MergePivotedData"
				},
				{
					"name": "Select1"
				},
				{
					"name": "TotalCasesDeathWeek"
				},
				{
					"name": "MapDrifted1",
					"description": "Creates an explicit mapping for each drifted column"
				},
				{
					"name": "MapDrifted2",
					"description": "Creates an explicit mapping for each drifted column"
				},
				{
					"name": "Year"
				},
				{
					"name": "Lookup1"
				},
				{
					"name": "Select2"
				}
			],
			"script": "source(output(\n\t\tcountry as string,\n\t\tcountry_code as string,\n\t\tcontinent as string,\n\t\tpopulation as integer,\n\t\tindicator as string,\n\t\tweekly_count as integer,\n\t\tyear_week as string,\n\t\trate_14_day as double,\n\t\tcumulative_count as integer,\n\t\tsource as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'delimited',\n\tfileSystem: 'covid',\n\tfolderPath: 'raw/cases_deaths',\n\tfileName: 'cases_deaths.csv',\n\tcolumnDelimiter: ',',\n\tescapeChar: '\\\\',\n\tquoteChar: '\\\"',\n\tcolumnNamesAsHeader: true) ~> srcCasesDeaths\nsource(output(\n\t\tCountry as string,\n\t\t{Alpha-2 code} as string,\n\t\t{Alpha-3 code} as string,\n\t\t{Country code} as short,\n\t\tNumeric as short,\n\t\tyear as string,\n\t\tPopulation as double\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'delimited',\n\tfileSystem: 'general',\n\tfolderPath: 'processed',\n\tfileName: 'PopulationByCountry.csv',\n\tcolumnDelimiter: ',',\n\tescapeChar: '\\\\',\n\tquoteChar: '\\\"',\n\tcolumnNamesAsHeader: true,\n\tpartitionBy('hash', 1)) ~> PopulationCountryCode\nSelect1 filter(equals(continent, 'Europe')) ~> ContinentEqEurope\nContinentEqEurope pivot(groupBy(year_week,\n\t\tcountry_code),\n\tpivotBy(indicator),\n\t{} = mean(rate_14_day),\n\tcolumnNaming: 'rate_$N$V',\n\tlateral: false) ~> pivotRateIndicator\nContinentEqEurope pivot(groupBy(year_week,\n\t\tcountry_code),\n\tpivotBy(indicator),\n\t{} = sum(weekly_count),\n\tcolumnNaming: 'weekly_count_$N$V',\n\tlateral: true) ~> pivotCountIndicator\nMapDrifted1, MapDrifted2 join(pivotCountIndicator@country_code == pivotRateIndicator@country_code\n\t&& pivotCountIndicator@year_week == pivotRateIndicator@year_week,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> MergePivotedData\nsrcCasesDeaths select(mapColumn(\n\t\tcountry_code,\n\t\tcontinent,\n\t\tindicator,\n\t\tweekly_count,\n\t\tyear_week,\n\t\trate_14_day,\n\t\tcumulative_count\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nMapDrifted1 aggregate(groupBy(year_week),\n\tweekly_count_cases = sum(weekly_count_cases),\n\t\tweekly_count_deaths = sum(weekly_count_deaths)) ~> TotalCasesDeathWeek\npivotCountIndicator derive(weekly_count_cases = toLong(byName('weekly_count_cases')),\n\t\tweekly_count_deaths = toLong(byName('weekly_count_deaths'))) ~> MapDrifted1\npivotRateIndicator derive(rate_cases = toDouble(byName('rate_cases')),\n\t\trate_deaths = toDouble(byName('rate_deaths'))) ~> MapDrifted2\nMergePivotedData derive(year = split(pivotCountIndicator@year_week,\"-\")[1]) ~> Year\nYear, PopulationCountryCode lookup(Year@year == PopulationCountryCode@year\n\t&& pivotCountIndicator@country_code == {Alpha-3 code},\n\tmultiple: true,\n\tbroadcast: 'auto')~> Lookup1\nLookup1 select(mapColumn(\n\t\tyear = Year@year,\n\t\tyear_week = pivotCountIndicator@year_week,\n\t\tPopulation,\n\t\tCountry,\n\t\t{Country code},\n\t\t{Alpha-2 code},\n\t\t{Alpha-3 code},\n\t\tweekly_count_cases,\n\t\tweekly_count_deaths,\n\t\trate_cases,\n\t\trate_deaths\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select2\nSelect2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'delimited',\n\tfileSystem: 'covid',\n\tfolderPath: 'processed/cases_deaths',\n\tcolumnDelimiter: ',',\n\tescapeChar: '\\\\',\n\tquoteChar: '\\\"',\n\tcolumnNamesAsHeader: true,\n\trowUrlColumn:'year_week',\n\tumask: 0222,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> sinkCasesDeaths"
		}
	}
}