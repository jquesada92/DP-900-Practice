{
	"name": "FlowCasesDeaths",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"linkedService": {
						"referenceName": "ls_adls_covid",
						"type": "LinkedServiceReference"
					},
					"name": "srcCasesDeaths"
				},
				{
					"linkedService": {
						"referenceName": "ls_adls_covid",
						"type": "LinkedServiceReference"
					},
					"name": "srcCountryCodes"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "ls_adls_covid",
						"type": "LinkedServiceReference"
					},
					"name": "sinkCasesDeaths"
				}
			],
			"transformations": [
				{
					"name": "ContinentEqEurope"
				},
				{
					"name": "pivotRateIndicator"
				},
				{
					"name": "pivotCountIndicator"
				},
				{
					"name": "MergePivotedData"
				},
				{
					"name": "CasesCountryCode"
				},
				{
					"name": "Select1"
				}
			],
			"script": "source(output(\n\t\tcountry as string,\n\t\tcountry_code as string,\n\t\tcontinent as string,\n\t\tpopulation as integer,\n\t\tindicator as string,\n\t\tweekly_count as integer,\n\t\tyear_week as string,\n\t\trate_14_day as double,\n\t\tcumulative_count as integer,\n\t\tsource as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'delimited',\n\tfileSystem: 'covid',\n\tfolderPath: 'raw/cases_deaths',\n\tfileName: 'cases_deaths.csv',\n\tcolumnDelimiter: ',',\n\tescapeChar: '\\\\',\n\tquoteChar: '\\\"',\n\tcolumnNamesAsHeader: true) ~> srcCasesDeaths\nsource(output(\n\t\t{_c0} as short,\n\t\tCountry as string,\n\t\t{Alpha-2 code} as string,\n\t\t{Alpha-3 code} as string,\n\t\tNumeric as short\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'delimited',\n\tfileSystem: 'general',\n\tfileName: 'country_codes.csv',\n\tcolumnDelimiter: ',',\n\tescapeChar: '\\\\',\n\tquoteChar: '\\\"',\n\tcolumnNamesAsHeader: true) ~> srcCountryCodes\nSelect1 filter(equals(continent, 'Europe')) ~> ContinentEqEurope\nContinentEqEurope pivot(groupBy(Select1@Country,\n\t\t{Alpha-2 code},\n\t\t{Alpha-3 code},\n\t\tcontinent,\n\t\tyear_week),\n\tpivotBy(indicator),\n\t{} = mean(rate_14_day),\n\tcolumnNaming: 'rate_$N$V',\n\tlateral: false) ~> pivotRateIndicator\nContinentEqEurope pivot(groupBy(Select1@Country,\n\t\t{Alpha-2 code},\n\t\t{Alpha-3 code},\n\t\tcontinent,\n\t\tyear_week),\n\tpivotBy(indicator),\n\t{} = sum(weekly_count),\n\tcolumnNaming: 'weekly_count_$N$V',\n\tlateral: true) ~> pivotCountIndicator\npivotRateIndicator, pivotCountIndicator join(pivotRateIndicator@Country == pivotCountIndicator@Country\n\t&& pivotRateIndicator@{Alpha-2 code} == pivotCountIndicator@{Alpha-2 code}\n\t&& pivotRateIndicator@{Alpha-3 code} == pivotCountIndicator@{Alpha-3 code}\n\t&& pivotRateIndicator@continent == pivotCountIndicator@continent\n\t&& pivotRateIndicator@year_week == pivotCountIndicator@year_week,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> MergePivotedData\nsrcCasesDeaths, srcCountryCodes lookup(country_code == {Alpha-3 code},\n\tmultiple: true,\n\tbroadcast: 'auto')~> CasesCountryCode\nCasesCountryCode select(mapColumn(\n\t\tcountry = srcCasesDeaths@country,\n\t\tcountry_code,\n\t\tcontinent,\n\t\tpopulation,\n\t\tindicator,\n\t\tweekly_count,\n\t\tyear_week,\n\t\trate_14_day,\n\t\tcumulative_count,\n\t\tsource,\n\t\t{_c0},\n\t\tCountry = srcCountryCodes@Country,\n\t\t{Alpha-2 code},\n\t\t{Alpha-3 code},\n\t\tNumeric\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nMergePivotedData sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'delimited',\n\tfileSystem: 'covid',\n\tfolderPath: 'processed/cases_deaths',\n\tcolumnDelimiter: ',',\n\tescapeChar: '\\\\',\n\tquoteChar: '\\\"',\n\tcolumnNamesAsHeader: true,\n\tpartitionFileNames:['cases_deaths'],\n\tumask: 0222,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> sinkCasesDeaths"
		}
	}
}