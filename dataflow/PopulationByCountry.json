{
	"name": "PopulationByCountry",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"linkedService": {
						"referenceName": "ls_adls_covid",
						"type": "LinkedServiceReference"
					},
					"name": "srcPopulation"
				},
				{
					"linkedService": {
						"referenceName": "ls_adls_covid",
						"type": "LinkedServiceReference"
					},
					"name": "srcCountryCode"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "ls_adls_covid",
						"type": "LinkedServiceReference"
					},
					"name": "SaveProcessed"
				}
			],
			"transformations": [
				{
					"name": "GetOnlyCountries"
				},
				{
					"name": "Join1"
				},
				{
					"name": "Unpivot1"
				},
				{
					"name": "SelecKeyAndYears"
				},
				{
					"name": "RemoveFirstCol"
				}
			],
			"script": "source(output(\n\t\tIndex as short,\n\t\tVariant as string,\n\t\t{Region, subregion, country or area *} as string,\n\t\tNotes as string,\n\t\t{Country code} as short,\n\t\tType as string,\n\t\t{Parent code} as short,\n\t\t{1950} as string,\n\t\t{1951} as string,\n\t\t{1952} as string,\n\t\t{1953} as string,\n\t\t{1954} as string,\n\t\t{1955} as string,\n\t\t{1956} as string,\n\t\t{1957} as string,\n\t\t{1958} as string,\n\t\t{1959} as string,\n\t\t{1960} as string,\n\t\t{1961} as string,\n\t\t{1962} as string,\n\t\t{1963} as string,\n\t\t{1964} as string,\n\t\t{1965} as string,\n\t\t{1966} as string,\n\t\t{1967} as string,\n\t\t{1968} as string,\n\t\t{1969} as string,\n\t\t{1970} as string,\n\t\t{1971} as string,\n\t\t{1972} as string,\n\t\t{1973} as string,\n\t\t{1974} as string,\n\t\t{1975} as string,\n\t\t{1976} as string,\n\t\t{1977} as string,\n\t\t{1978} as string,\n\t\t{1979} as string,\n\t\t{1980} as string,\n\t\t{1981} as string,\n\t\t{1982} as string,\n\t\t{1983} as string,\n\t\t{1984} as string,\n\t\t{1985} as string,\n\t\t{1986} as string,\n\t\t{1987} as string,\n\t\t{1988} as string,\n\t\t{1989} as string,\n\t\t{1990} as string,\n\t\t{1991} as string,\n\t\t{1992} as string,\n\t\t{1993} as string,\n\t\t{1994} as string,\n\t\t{1995} as string,\n\t\t{1996} as string,\n\t\t{1997} as string,\n\t\t{1998} as string,\n\t\t{1999} as string,\n\t\t{2000} as string,\n\t\t{2001} as string,\n\t\t{2002} as string,\n\t\t{2003} as string,\n\t\t{2004} as string,\n\t\t{2005} as string,\n\t\t{2006} as string,\n\t\t{2007} as string,\n\t\t{2008} as string,\n\t\t{2009} as string,\n\t\t{2010} as string,\n\t\t{2011} as string,\n\t\t{2012} as string,\n\t\t{2013} as string,\n\t\t{2014} as string,\n\t\t{2015} as string,\n\t\t{2016} as string,\n\t\t{2017} as string,\n\t\t{2018} as string,\n\t\t{2019} as string,\n\t\t{2020} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tignoreNoFilesFound: false,\n\tpurgeFiles: true,\n\tformat: 'excel',\n\tfileSystem: 'general',\n\tfolderPath: 'raw',\n\tfileName: 'Population.xlsx',\n\tsheetName: 'ESTIMATES',\n\trange: 'A17:BZ999',\n\tfirstRowAsHeader: true,\n\tpreferredFractionalType: 'decimal') ~> srcPopulation\nsource(output(\n\t\t{_c0} as short,\n\t\tCountry as string,\n\t\t{Alpha-2 code} as string,\n\t\t{Alpha-3 code} as string,\n\t\tNumeric as short\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'delimited',\n\tfileSystem: 'general',\n\tfileName: 'country_codes.csv',\n\tcolumnDelimiter: ',',\n\tescapeChar: '\\\\',\n\tquoteChar: '\\\"',\n\tcolumnNamesAsHeader: true) ~> srcCountryCode\nsrcPopulation filter(equals(Type, \"Country/Area\")) ~> GetOnlyCountries\nRemoveFirstCol, SelecKeyAndYears join(Numeric == {Country code},\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> Join1\nJoin1 unpivot(output(\n\t\tyear as string,\n\t\t{} as string\n\t),\n\tungroupBy(Country,\n\t\t{Alpha-2 code},\n\t\t{Alpha-3 code},\n\t\t{Country code},\n\t\tNumeric),\n\tlateral: false,\n\tignoreNullPivots: true) ~> Unpivot1\nGetOnlyCountries select(mapColumn(\n\t\t{Country code},\n\t\teach(patternMatch(`\\d+`, true()))\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelecKeyAndYears\nsrcCountryCode select(mapColumn(\n\t\tCountry,\n\t\t{Alpha-2 code},\n\t\t{Alpha-3 code},\n\t\tNumeric\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RemoveFirstCol\nUnpivot1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'delimited',\n\tfileSystem: 'general',\n\tfolderPath: 'processed',\n\tcolumnDelimiter: ',',\n\tescapeChar: '\\\\',\n\tquoteChar: '\\\"',\n\tcolumnNamesAsHeader: false,\n\tumask: 0222,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SaveProcessed"
		}
	}
}